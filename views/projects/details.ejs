<!DOCTYPE html>
<html lang="en">
  <head>
    <%- include('../partials/head.ejs') %>
  </head>
  <body>
    <div class="container">
      <%- include('../partials/nav.ejs') %>

      <div class="card">
        <div class="card-body">
          <% if(project.length > 0){%> <% project.map((pjt,index)=>{ %>
          <div
            class="row"
            style="
              display: flex;
              justify-content: center;
              align-items: center;
              background: linear-gradient(
                  0deg,
                  rgba(14, 25, 48, 1) 11%,
                  rgba(14, 25, 48, 0.7685324618128502) 45%,
                  rgba(14, 25, 48, 0.2531262993478641) 95%
                ),
                url('<%=pjt.picture_url%>') no-repeat;
              background-size: cover;
            "
          >
            <div id="details">
              <div class="row">
                <div class="col-lg-6">
                  <img
                    src="<%= pjt.picture_url  %>"
                    alt="<%= pjt.title%>"
                    class="image"
                  />
                </div>
                <div class="col-lg-6">
                  <h3 class="card-title"><%= pjt.title%></h3>
                  <em><span><%= pjt.snippet %></span></em>
                  <p class="card-text">
                    <%= pjt.description %>
                  </p>
                </div>
              </div>
            </div>
            <div hidden id="update-section" class="card text-center w-50">
              <div class="card-header">
                <h5><strong>Edit Project</strong></h5>
              </div>
              <div class="card-body">
                <form action="/projects/<%=pjt.id%>" method="POST">
                  <div class="mb-3">
                    <input
                      type="text"
                      class="form-control"
                      name="title"
                      placeholder="Project Title"
                      value="<%= pjt.title  %> "
                      required
                    />
                  </div>
                  <div class="mb-3">
                    <input
                      type="text"
                      class="form-control"
                      name="snippet"
                      placeholder="Project Tags"
                      value="<%= pjt.snippet  %> "
                      required
                    />
                  </div>
                  <div class="mb-3">
                    <textare
                      class="form-control"
                      name="description"
                      placeholder="Project Description"
                      rows="3"
                      required
                      ><%=pjt.description %></textare
                    >
                  </div>
                  <div class="row">
                    <div class="col">
                      <label for="start-date" class="form-label"
                        >Starting Date</label
                      >
                      <input
                        type="date"
                        class="form-control"
                        id="start_date"
                        name="start_date"
                        value="<%= pjt.start_date  %> "
                        required
                      />
                    </div>
                    <div class="col">
                      <label for="end-date" class="form-label"
                        >Ending Date</label
                      >
                      <input
                        type="date"
                        class="form-control"
                        id="end_date"
                        name="end_date"
                        value="<%= pjt.end_date  %> "
                        required
                      />
                    </div>
                  </div>
                  <br />
                  <div class="row">
                    <div class="col-10">
                      <input
                        type="file"
                        class="form-control"
                        id="file-upload"
                      />
                    </div>
                    <div
                      hidden
                      class="col-2 spinner-border"
                      role="status"
                      id="loader"
                    >
                      <span class="visually-hidden">Loading...</span>
                    </div>
                    <input
                      type="hidden"
                      name="picture_url"
                      id="picture_url"
                      value="<%= pjt.picture_url  %> "
                    />
                  </div>
                  <br />
                  <div class="d-grid gap-2">
                    <button class="btn btn-success" type="submit">Save</button>
                    <a class="btn btn-info btn-sm" id="close-btn">
                      Close
                    </a>
                  </div>
                </form>
              </div>
            </div>
            <br />
            <div style="text-align: center;" id="control">
              <a href="/projects" class="btn btn-info">Back</a>
              <a class="btn btn-success" id="btn-edit">Edit</a>
            </div>
            <br />
          </div>
          <% })} %>
        </div>
      </div>

      <%- include('../partials/footer.ejs') %>
    </div>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script>
      const editBtn = document.getElementById("btn-edit");
      const closeBtn = document.getElementById("close-btn");

      const fileUpload = document.getElementById("file-upload");
      const pictureUrl = document.getElementById("picture_url");

      const editSection = document.getElementById("update-section");
      const detailsSection = document.getElementById("details");
      const controlBtn = document.getElementById("control");
      const loader = document.getElementById("loader");

      editBtn.addEventListener("click", (e) => {
        editSection.hidden = false;
        detailsSection.hidden = true;
        controlBtn.hidden = true;
      });

      closeBtn.addEventListener("click", (e) => {
        detailsSection.hidden = false;
        controlBtn.hidden = false;
        editSection.hidden = true;
      });

      fileUpload.addEventListener("change", (event) => {
        loader.hidden = false;
        const file = event.target.files[0];
        const formData = new FormData();
        formData.append("file", file);
        formData.append("upload_preset", CLOUDINARY_UPLOAD_PRESET);

        axios({
          url: CLOUDINARY_URL,
          method: "POST",
          header: {
            "Content-Type": "application/x-www-form-urlencoded",
          },
          data: formData,
        })
          .then((res) => {
            loader.hidden = true;
            pictureUrl.value = res.data.secure_url;
          })
          .catch((err) => {
            console.log(err);
          });
      });
    </script>
  </body>
</html>
